name: Deploy to QA

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node (needed for sfdx)
        uses: actions/setup-node@v4
        with:
          node-version: '20'   # choose LTS

      - name: Install Salesforce CLI
        run: npm install -g sfdx-cli

      - name: Prepare SFDX auth file from secret
        run: |
          mkdir -p ./auth
          # Use printf to preserve exact content/newlines if any
          printf "%s" "${{ secrets.SFDX_AUTH_URL_QA }}" > ./auth/qa.txt
          # show file exists (do not print contents)
          ls -la ./auth

      - name: Authenticate to QA (SFDX URL)
        # Use sfdx or sf depending on your CLI; uncomment the one you use.
        run: |
          # Using sfdx:
          sfdx auth:sfdxurl:store -f ./auth/qa.txt -a QA
          # Or, if you prefer the new CLI (sf), use:
          # sf auth sfdxurl store --file ./auth/qa.txt --alias QA

      - name: Verify authenticated user
        run: sfdx force:org:display -u QA --json

      - name: Deploy metadata to QA
        run: |
          # deploy the force-app folder. Add --testlevel RunLocalTests or other flags if needed.
          sfdx force:source:deploy -p force-app -u QA --wait 10
