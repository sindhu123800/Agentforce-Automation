name: Deploy to Salesforce
 
on:
  push:
    branches:
      - main    # change as needed
    paths:
      - "force-app/**"
      - "src/**"
      - "sfdx-project.json"
  workflow_dispatch: {}
 
jobs:
  deploy:
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
 
      - name: Setup Node (for sf/sfdx CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
 
      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          # Optionally: also install legacy sfdx plugin if you need it
          sf --version
 
      - name: Auth to Salesforce (JWT)
        env:
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
          SF_CONSUMER_KEY: ${{ secrets.SF_CONSUMER_KEY }}
          SF_LOGIN_URL: ${{ secrets.SF_LOGIN_URL }}
          SF_JWT_KEY: ${{ secrets.SF_JWT_KEY }}
        run: |
          # Write the private key into a file
          echo "$SF_JWT_KEY" > jwt.key
          # Authenticate using JWT
          sf org login jwt \
            --username "$SF_USERNAME" \
            --jwt-key-file jwt.key \
            --client-id "$SF_CONSUMER_KEY" \
            --instance-url "$SF_LOGIN_URL" \
            --alias ciOrg \
            --set-default
 
      - name: Detect format (SFDX vs Metadata)
        id: detect
        run: |
          if [ -d "force-app" ]; then
            echo "format=sfdx" >> $GITHUB_OUTPUT
          elif [ -d "src" ]; then
            echo "format=mdapi" >> $GITHUB_OUTPUT
          else
            echo "No Salesforce metadata found"; exit 1
          fi
 
      - name: Build deployment artifact
        run: |
          if [ "${{ steps.detect.outputs.format }}" = "sfdx" ]; then
            # Optionally convert only changed files; here we convert full source
            sf project convert source --output-dir mdapi_out
          else
            mkdir -p mdapi_out
            cp -r src mdapi_out
          fi
          # Validate package.xml exists (auto-generated for sfdx conversion)
          test -f mdapi_out/package.xml || echo "Warning: package.xml missing"
 
      - name: Run Apex tests (optional but recommended)
        env:
          TEST_LEVEL: ${{ secrets.DEPLOY_TEST_LEVEL }}
          APEX_TESTS: ${{ secrets.APEX_TESTS }}
        run: |
          # If specific tests are provided, run them; else default to RunLocalTests
          if [ -n "$APEX_TESTS" ]; then
            TEST_LEVEL="RunSpecifiedTests"
            TEST_ARGS="--tests $APEX_TESTS"
          fi
          # Test run with deploy --checkonly to validate before real deploy
          sf deploy metadata \
            --target-org ciOrg \
            --metadata-dir mdapi_out \
            --check-only \
            --test-level "${TEST_LEVEL:-RunLocalTests}" \
            $([ -n "$TEST_ARGS" ] && echo "$TEST_ARGS") \
            --json || exit 1
 
      - name: Deploy to Org (actual deployment)
        env:
          TEST_LEVEL: ${{ secrets.DEPLOY_TEST_LEVEL }}
          APEX_TESTS: ${{ secrets.APEX_TESTS }}
        run: |
          if [ -n "$APEX_TESTS" ]; then
            TEST_LEVEL="RunSpecifiedTests"
            TEST_ARGS="--tests $APEX_TESTS"
          fi
          sf deploy metadata \
            --target-org ciOrg \
            --metadata-dir mdapi_out \
            --test-level "${TEST_LEVEL:-RunLocalTests}" \
            $([ -n "$TEST_ARGS" ] && echo "$TEST_ARGS") \
            --wait 30 \
            --json
 
